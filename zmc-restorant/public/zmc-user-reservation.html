<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZMC Online Restaurant - Masa Rezervasyonu</title>
  <style>
        /* CSS Custom Properties (Variables) */
        :root {
            --primary-color: #ff6b9d;
            --primary-gradient: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            --secondary-gradient: linear-gradient(135deg, #502596 0%, #fed6e3 100%);
            --header-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --success-color: #55efc4;
            --success-gradient: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            --danger-color: #fd79a8;
            --danger-gradient: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            --warning-color: #fdcb6e;
            --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            --purple-gradient: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            --blue-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            --gray-color: #636e72;
            --light-gray: #f8f9ff;
            --lighter-gray: #ffffff;
            --border-color: #e4e6ea;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --white: #ffffff;
            --shadow-light: 0 4px 15px rgba(98, 153, 207, 0.15);
            --shadow-medium: 0 8px 25px rgba(116, 185, 255, 0.2);
            --shadow-heavy: 0 15px 45px rgba(116, 185, 255, 0.25);
            --shadow-colored: 0 8px 32px rgba(255, 107, 157, 0.3);
            --border-radius: 12px;
            --border-radius-large: 20px;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Reset and Base Styles */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--secondary-gradient);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        /* Layout Components */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--lighter-gray);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .header {
            background: var(--header-gradient);
            color: var(--white);
            text-align: center;
            padding: 30px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            padding: 30px;
            min-height: 70vh;
        }

        /* Section Styles */
        .section {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow-light);
        }

        .section h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
        }

        /* Restaurant Layout */
        .restaurant-layout {
            position: relative;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .restaurant-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #ff6b6b, var(--warning-color), #48dbfb, #ff9ff3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.1em;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            background-size: cover;
            background-position: center;
        }

        .restaurant-info {
            padding: 15px;
            background: var(--white);
        }

        .restaurant-name {
            color: var(--text-primary);
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .restaurant-about {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.6;
            background: var(--light-gray);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 10px;
        }

        /* Table Layout Visual */
        .table-layout-visual {
            position: relative;
            background: var(--light-gray);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            height: 300px;
            width: 100%;
            margin: 15px 0;
            padding: 10px;
        }

        .visual-table {
            position: absolute;
            background: var(--primary-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 0.8em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            line-height: 1;
        }

        .visual-table:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }

        .visual-table.selected {
            background: var(--success-color);
            transform: scale(1.1);
        }

        .visual-table.occupied {
            background: var(--danger-color) !important;
            color: var(--white) !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            opacity: 0.6 !important;
            border-color: var(--danger-color) !important;
        }

        /* Table Grid */
        .table-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .table-item {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .table-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .table-item.selected {
            border-color: var(--primary-color);
            background: #f369e8;
        }

        .table-item.occupied {
            background: var(--danger-color) !important;
            color: var(--white) !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            opacity: 0.6 !important;
            border-color: var(--danger-color) !important;
        }

        .table-number {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .table-type {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        /* Guest Count Buttons */
        .guest-count {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .guest-btn {
            background: var(--gray-color);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
        }

        .guest-btn.active {
            background: var(--primary-color);
        }

        .guest-btn:hover:not(.active) {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Primary Button */
        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: var(--transition);
            font-family: inherit;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-primary:disabled {
            background: var(--gray-color);
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        /* Selected Info */
        .selected-info {
            background: #cc57f0;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border-left: 4px solid var(--primary-color);
        }

        /* Time Slots */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .time-slot {
            background: var(--white);
            border: 2px solid var(--border-color);
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9em;
        }

        .time-slot:hover:not(.unavailable) {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .time-slot.unavailable {
            background: var(--light-gray);
            color: var(--gray-color);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Menu Styles */
        .menu-categories {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--light-gray);
        }

        .menu-categories::-webkit-scrollbar {
            width: 6px;
        }

        .menu-categories::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 3px;
        }

        .menu-categories::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .menu-category {
            margin-bottom: 20px;
            background: var(--white);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .menu-category h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .item-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .item-price {
            color: var(--primary-color);
            font-weight: 700;
        }

        /* Floor Tabs */
        .floor-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .floor-tab {
            background: var(--gray-color);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9em;
            font-family: inherit;
        }

        .floor-tab.active {
            background: var(--primary-color);
        }

        .floor-tab:hover:not(.active) {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        /* Utility Classes */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Responsive Design */
        @media screen and (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 25px;
            }
        }

        @media screen and (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header {
                font-size: 1.8em;
                padding: 20px;
            }
            
            .table-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .time-slots {
                grid-template-columns: repeat(2, 1fr);
            }

            .guest-count {
                justify-content: center;
            }

            .floor-tabs {
                justify-content: center;
            }
        }

        @media screen and (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header {
                font-size: 1.5em;
                padding: 15px;
            }

            .section {
                padding: 20px;
            }

            .table-grid {
                grid-template-columns: 1fr;
            }

            .time-slots {
                grid-template-columns: 1fr;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --white: #1a1a1a;
                --light-gray: #2d2d2d;
                --text-primary: #ffffff;
                --text-secondary: #cccccc;
                --border-color: #404040;
            }

            body {
                color: var(--text-primary);
            }

            .section {
                background: var(--light-gray);
            }
        }

        /* Focus Styles for Accessibility */
        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
    </head>
<body>
    <div class="container">
        <div class="header">
            ZMC Online Restaurant
        </div>
        
        <div class="main-content">
            <!-- Restaurant Layout Section -->
            <div class="section">
                <h2>Restoran Bilgileri</h2>
                <div class="restaurant-layout">
                    <div class="restaurant-image" id="restaurantImage">
                        <div class="loading">Yükleniyor...</div>
                    </div>
                    <div class="restaurant-info">
                        <div class="restaurant-name" id="restaurantName">Yükleniyor...</div>
                        <div class="restaurant-about" id="restaurantAbout">
                            <h4 style="margin-bottom: 10px; color: #4facfe;">📝 Hakkımızda</h4>
                            <div>Restoran bilgileri yükleniyor...</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: #c5bbbb;">Masa Düzeni</h3>
                <div class="form-group">
                    <label>Katlar:</label>
                    <div class="floor-tabs" id="floorTabs">
                        <div class="loading">Katlar yükleniyor...</div>
                    </div>
                </div>
                
                <div class="table-layout-visual" id="visualLayout">
                    <div class="loading">Masa düzeni yükleniyor...</div>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 15px; color: #f1eded;">Masa Listesi</h3>
                    <div class="table-grid" id="tableGrid">
                        <div class="loading">Masalar yükleniyor...</div>
                    </div>
                </div>
            </div>

            <!-- Menu Section -->
            <div class="section">
                <h2>Menü</h2>
                
                <div class="menu-categories" id="menuCategories">
                    <div class="loading">Menü yükleniyor...</div>
                </div>
            </div>

            <!-- Reservation Section -->
            <div class="section">
                <h2>Masa Rezervasyonu</h2>
                
                <div class="form-group">
                    <label>Tarih Seç:</label>
                    <input type="date" id="dateInput" min="">
                </div>

                <div class="form-group">
                    <label>Saat Seç:</label>
                    <div class="time-slots" id="timeSlots">
                        <!-- Time slots will be generated by JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Masa Türü:</label>
                    <select id="tableType">
                        <option value="">Masa türü seçin</option>
                        <option value="small">Küçük Masa</option>
                        <option value="big">Büyük Masa</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Kişi Sayısı:</label>
                    <div class="guest-count" id="guestCount">
                        <button type="button" class="guest-btn" data-count="1">1</button>
                        <button type="button" class="guest-btn" data-count="2">2</button>
                        <button type="button" class="guest-btn" data-count="3">3</button>
                        <button type="button" class="guest-btn" data-count="4">4</button>
                        <button type="button" class="guest-btn" data-count="5">5</button>
                        <button type="button" class="guest-btn" data-count="6">6+</button>
                    </div>
                </div>

                <div id="selectedInfo" class="selected-info" style="display: none;">
                    <h4>Rezervasyon Özeti:</h4>
                    <div id="summaryContent"></div>
                </div>

                <button class="btn-primary" id="bookBtn" disabled>Rezervasyon Yap</button>

                <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                    <div><strong>Dolu:</strong> <span id="fullCount">0</span></div>
                    <div><strong>Boş:</strong> <span id="emptyCount">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('userId');
        // Global variables
        let restaurantData = null;
        let currentFloor = null;
        let selectedTable = null;
        let selectedTime = null;
        let selectedGuests = null;
        
        // Get restaurant ID from URL parameters (you can modify this as needed)
        const urlParams = new URLSearchParams(window.location.search);
        const restIdParam = urlParams.get('restId');   // URL parametresi kesin restId
        const restaurantId = restIdParam ? Number(restIdParam) : 1; 
        // Initialize date input with today's date
        const today = new Date();
        const dateInput = document.getElementById('dateInput');
        dateInput.min = today.toISOString().split('T')[0];
        dateInput.value = today.toISOString().split('T')[0];

        // Time slots
       const timeSlots = ['18:00', '19:00', '20:00', '21:00', '22:00','23:00'];

        const unavailableSlots = []; // Some example unavailable slots

        // Fetch restaurant data from server
        async function fetchRestaurantData() {
            try {
                const response = await fetch(`/api/restaurant/${restaurantId}`);
                const data = await response.json();
                
                if (data.success) {
                    restaurantData = data;
                    renderRestaurantInfo();
                    renderFloors();
                    renderMenu();
                    // Set first floor as default
                    if (data.floors.length > 0) {
                        selectFloor(data.floors[0].FloorName);
                    }
                } else {
                    console.error('Restaurant data not found');
                    showError('Restoran bilgileri bulunamadı');
                }
            } catch (error) {
                console.error('Error fetching restaurant data:', error);
                showError('Restoran bilgileri yüklenirken hata oluştu');
            }
        }

        // Render restaurant information
        function renderRestaurantInfo() {
            const restaurant = restaurantData.restaurant;
            
            // Update restaurant image
            const restaurantImage = document.getElementById('restaurantImage');
            if (restaurant.CoverImage) {
                restaurantImage.style.backgroundImage = `url(${restaurant.CoverImage})`;
                restaurantImage.innerHTML = '';
            } else {
                restaurantImage.innerHTML = `<div>🍽️ ${restaurant.Name}</div>`;
            }
            
            // Update restaurant name
            document.getElementById('restaurantName').textContent = restaurant.Name;
            
            // Update about section
            const aboutSection = document.getElementById('restaurantAbout');
            aboutSection.innerHTML = `
                <h4 style="margin-bottom: 10px; color: #4facfe;">📝 Hakkımızda</h4>
                <div>${restaurant.About || 'Bu restoran hakkında henüz bilgi eklenmemiş.'}</div>
            `;
        }

        // Render floors
        function renderFloors() {
            const floorTabs = document.getElementById('floorTabs');
            floorTabs.innerHTML = '';
            
            restaurantData.floors.forEach(floor => {
                const floorTab = document.createElement('button');
                floorTab.className = 'floor-tab';
                floorTab.textContent = floor.FloorName;
                floorTab.onclick = () => selectFloor(floor.FloorName);
                floorTabs.appendChild(floorTab);
            });
        }
async function renderTablesWithOccupancy(tables, restaurantId, date, time) {
    const occupiedTableIds = await fetchOccupiedTables(restaurantId, date, time);

    const tableGrid = document.getElementById('tableGrid');
    tableGrid.innerHTML = '';

    tables.forEach(table => {
        const isOccupied = occupiedTableIds.includes(table.Id);

        const tableElement = document.createElement('div');
        tableElement.className = `table-item ${isOccupied ? 'occupied' : ''}`;
        tableElement.setAttribute('data-table-id', table.Id);
        tableElement.innerHTML = `
            <div class="table-number">${table.TableName}</div>
            <div class="table-type">${table.Type}</div>
        `;

        if (!isOccupied) {
            tableElement.addEventListener('click', () => {
                selectTable(table, tableElement);
            });
        } else {
            // Dolu masa seçilemez
            tableElement.title = "Bu masa dolu";
        }

        tableGrid.appendChild(tableElement);
        table.occupied = isOccupied;  // Doluluk bilgisini tables dizisine işlemek için
    });

    updateCounts(tables);
}

        // Select floor and render tables
        async function selectFloor(floorName) {
            currentFloor = floorName;

    document.querySelectorAll('.floor-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === floorName);
    });

    const floor = restaurantData.floors.find(f => f.FloorName === floorName);
    const floorTables = restaurantData.tables.filter(t => t.FloorId === floor.Id);

    // Tarih ve saat seçilmişse dolu masaları da dikkate alarak render yap
    const date = dateInput.value;
    const time = selectedTime;

    if (date && time) {
        await renderTablesWithOccupancy(floorTables, restaurantId, date, time);
    } else {
        renderTables(floorTables);
    }

    renderVisualLayout(floorTables);
}
// Tarih veya saat değiştiğinde çağır
dateInput.addEventListener('change', async () => {
    generateTimeSlots();  // Saatleri güncelle

    // Seçilen saat varsa doluluk kontrolü ile render et
    if (selectedTime) {
        const floor = restaurantData.floors.find(f => f.FloorName === currentFloor);
        if (!floor) return;
        const floorTables = restaurantData.tables.filter(t => t.FloorId === floor.Id);
        await renderTablesWithOccupancy(floorTables, restaurantId, dateInput.value, selectedTime);
    }
    updateSummary();
    checkBookingAvailability();
});
async function selectTime(time, element) {
    document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    selectedTime = time;

    // Doluluk kontrolü ile render et
    const floor = restaurantData.floors.find(f => f.FloorName === currentFloor);
    if (!floor) return;
    const floorTables = restaurantData.tables.filter(t => t.FloorId === floor.Id);

    await renderTablesWithOccupancy(floorTables, restaurantId, dateInput.value, selectedTime);

    updateSummary();
    checkBookingAvailability();
}
        // Render tables
        function renderTables(tables) {
            const tableGrid = document.getElementById('tableGrid');
            tableGrid.innerHTML = '';
            
            tables.forEach(table => {
                const tableElement = document.createElement('div');
                tableElement.className = `table-item`;
                tableElement.setAttribute('data-table-id', table.Id);
                tableElement.innerHTML = `
                    <div class="table-number">${table.TableName}</div>
                    <div class="table-type">${table.Type}</div>
                `;
                
                tableElement.addEventListener('click', () => {
                    selectTable(table, tableElement);
                });
                
                tableGrid.appendChild(tableElement);
            });
            
            updateCounts(tables);
        }

      function renderVisualLayout(tables) {
    const visualLayout = document.getElementById('visualLayout');
    visualLayout.innerHTML = '';
    
    const cols = Math.min(4, tables.length);
    const rows = Math.ceil(tables.length / cols);
    
    tables.forEach((table, index) => {
        const visualTable = document.createElement('div');
        visualTable.className = 'visual-table';
        if (table.occupied) {
            visualTable.classList.add('occupied');
        }

        // Masa tipine ve Rotation değerine göre şekil ve boyut ayarlama
        let width = '10%';
        let height = '10%';

        if (table.Type === 'small') {
            width = height = '30px'; // Kare küçük masa
        } else if (table.Type === 'big') {
             if (table.Rotation === 90) {
               width = '30px';
               height = '60px'; // Dikey
         } else {
            width = '60px';
             height = '30px'; // Yatay
         }
        }

        visualTable.style.width = width;
        visualTable.style.height = height;
        visualTable.style.position = 'absolute';

        const col = index % cols;
        const row = Math.floor(index / cols);

        visualTable.style.left = `${col * 10 + 3}px`;
        visualTable.style.top = `${row * 10 + 3}px`;

        if (table.PosX !== undefined && table.PosY !== undefined) {
            visualTable.style.left = `${table.PosX}px`;
            visualTable.style.top = `${table.PosY}px`;
        }

        visualTable.textContent = table.TableName;
        visualTable.title = `${table.TableName} - ${table.Type}`;

        if (!table.occupied) {
            visualTable.addEventListener('click', () => {
                selectTableFromVisual(table, visualTable);
            });
        } else {
            visualTable.title = "Bu masa dolu";
            visualTable.style.pointerEvents = 'none';
            visualTable.style.cursor = 'not-allowed';
        }

        visualLayout.appendChild(visualTable);
    });
}



        // Render menu
        function renderMenu() {
            const menuCategories = document.getElementById('menuCategories');
            menuCategories.innerHTML = '';
            
            if (!restaurantData.menu.categories || restaurantData.menu.categories.length === 0) {
                menuCategories.innerHTML = '<div class="loading">Menü bulunamadı</div>';
                return;
            }
            
            restaurantData.menu.categories.forEach(category => {
                const categoryItems = restaurantData.menu.items.filter(item => item.category === category.name);
                
                if (categoryItems.length > 0) {
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'menu-category';
                    
                    let categoryHtml = `<h3 style="color: #4facfe; margin-bottom: 10px;">🍽️ ${category.name}</h3>`;
                    
                    categoryItems.forEach(item => {
                        categoryHtml += `
                            <div class="menu-item">
                                <span class="item-name">${item.name}</span>
                                <span class="item-price">₺${item.price}</span>
                            </div>
                        `;
                    });
                    
                    categoryElement.innerHTML = categoryHtml;
                    menuCategories.appendChild(categoryElement);
                }
            });
        }

        // Select table
        function selectTable(table, element) {
            // Remove previous selections
            document.querySelectorAll('.table-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.visual-table').forEach(el => el.classList.remove('selected'));
            
            // Add selection
            element.classList.add('selected');
            selectedTable = table;
            
            updateSummary();
            checkBookingAvailability();
        }

        // Select table from visual layout
        function selectTableFromVisual(table, element) {
            // Remove previous selections
            document.querySelectorAll('.table-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.visual-table').forEach(el => el.classList.remove('selected'));
            
            // Add selection
            element.classList.add('selected');
            document.querySelector(`[data-table-id="${table.Id}"]`)?.classList.add('selected');
            selectedTable = table;
            
            updateSummary();
            checkBookingAvailability();
        }

        // Generate time slots
        function generateTimeSlots() {
    const timeSlotsContainer = document.getElementById('timeSlots');
    timeSlotsContainer.innerHTML = '';

    const selectedDateStr = dateInput.value;
    const now = new Date();
    const selectedDate = new Date(selectedDateStr + 'T00:00:00');

    let filteredSlots = [];

    if (selectedDate.toDateString() === now.toDateString()) {
        const currentHour = now.getHours();

        // Güncel saatten küçük olan saatleri filtrele
        filteredSlots = timeSlots.filter(slot => {
            const slotHour = parseInt(slot.split(':')[0], 10);
            return slotHour >= currentHour;
        });
    } else {
        // Gelecek günler için tüm saatler açık
        filteredSlots = [...timeSlots];
    }

    if (filteredSlots.length === 0) {
        // Eğer bugün için uygun saat yoksa, bilgi ver
        const info = document.createElement('div');
        info.textContent = 'Bugün için uygun saat kalmadı';
        info.style.color = '#f44336';
        timeSlotsContainer.appendChild(info);
        return;
    }

    filteredSlots.forEach(time => {
        const timeElement = document.createElement('div');
        timeElement.className = `time-slot ${unavailableSlots.includes(time) ? 'unavailable' : ''}`;
        timeElement.textContent = time;

        if (!unavailableSlots.includes(time)) {
            timeElement.addEventListener('click', () => selectTime(time, timeElement));
        }

        timeSlotsContainer.appendChild(timeElement);
    });
}


        // Select time
        function selectTime(time, element) {
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = time;
            
            updateSummary();
            checkBookingAvailability();
        }

        // Guest count selection
        document.getElementById('guestCount').addEventListener('click', (e) => {
            if (e.target.classList.contains('guest-btn')) {
                document.querySelectorAll('.guest-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                selectedGuests = e.target.dataset.count;
                
                updateSummary();
                checkBookingAvailability();
            }
        });

        // Update summary
        function updateSummary() {
            const selectedInfo = document.getElementById('selectedInfo');
            const summaryContent = document.getElementById('summaryContent');
            
            if (selectedTable || selectedTime || selectedGuests) {
                selectedInfo.style.display = 'block';
                let summary = '';
                
                if (selectedTable) {
                    summary += `<div><strong>Masa:</strong> ${selectedTable.TableName} (${selectedTable.Type})</div>`;
                }
                if (selectedTime) {
                    summary += `<div><strong>Saat:</strong> ${selectedTime}</div>`;
                }
                if (selectedGuests) {
                    summary += `<div><strong>Kişi Sayısı:</strong> ${selectedGuests}</div>`;
                }
                if (dateInput.value) {
                    summary += `<div><strong>Tarih:</strong> ${dateInput.value}</div>`;
                }
                
                summaryContent.innerHTML = summary;
            } else {
                selectedInfo.style.display = 'none';
            }
        }

        // Check booking availability
        function checkBookingAvailability() {
            const bookBtn = document.getElementById('bookBtn');
            
            if (selectedTable && selectedTime && selectedGuests && dateInput.value) {
                bookBtn.disabled = false;
            } else {
                bookBtn.disabled = true;
            }
        }

        // Update counts
        function updateCounts(tables) {
            const fullCount = tables.filter(table => table.occupied).length;
            const emptyCount = tables.filter(table => !table.occupied).length;
            
            document.getElementById('fullCount').textContent = fullCount;
            document.getElementById('emptyCount').textContent = emptyCount;
        }

        // Show error message
        function showError(message) {
            document.getElementById('restaurantImage').innerHTML = `<div style="color: #f44336;">❌ ${message}</div>`;
            document.getElementById('restaurantName').textContent = 'Hata';
            document.getElementById('restaurantAbout').innerHTML = `<div style="color: #f44336;">${message}</div>`;
            document.getElementById('floorTabs').innerHTML = `<div style="color: #f44336;">${message}</div>`;
            document.getElementById('tableGrid').innerHTML = `<div style="color: #f44336;">${message}</div>`;
            document.getElementById('menuCategories').innerHTML = `<div style="color: #f44336;">${message}</div>`;
        }

        // Book table
       document.getElementById('bookBtn').addEventListener('click', async () => {
    if (!selectedTable || !selectedTime || !selectedGuests || !restaurantData) {
        alert("Lütfen tüm alanları doldurun.");
        return;
    }

    const userId = localStorage.getItem('userId');
    if (!userId) {
        alert("Lütfen giriş yapınız.");
        return;
    }

    const reservationData = {
        UserId: Number(userId),
        RestaurantId: restaurantData.restaurant.Id,
        TableId: selectedTable.Id,
        ReservationDate: dateInput.value,
        ReservationTime: selectedTime
    };

    try {
        const response = await fetch('/api/reservations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(reservationData)
        });

        const result = await response.json();

        if (result.success) {
            alert("Rezervasyon başarıyla yapıldı!");
             // Doluluğu tekrar çekip masaları güncelle
             if (restaurantData && selectedTime && dateInput.value && currentFloor) {
                  const floor = restaurantData.floors.find(f => f.FloorName === currentFloor);
                if (floor) {
                     const floorTables = restaurantData.tables.filter(t => t.FloorId === floor.Id);
                    await renderTablesWithOccupancy(floorTables, restaurantId, dateInput.value, selectedTime);
            }
            }
            // Seçimleri sıfırla ve UI'ı temizle
            selectedTable = null;
            selectedTime = null;
            selectedGuests = null;

            document.querySelectorAll('.table-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.visual-table').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.guest-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('selectedInfo').style.display = 'none';
            document.getElementById('bookBtn').disabled = true;

            // İstersen rezervasyon sonrası başka işlemler de yapabilirsin
        } else {
            alert("Rezervasyon başarısız: " + (result.message || "Bilinmeyen hata"));
        }
    } catch (error) {
        alert("Sunucu ile iletişim kurulamadı.");
        console.error("Rezervasyon hatası:", error);
    }
});
async function fetchOccupiedTables(restaurantId, date, time) {
    try {
        const response = await fetch(`/api/reservations/occupied?restaurantId=${restaurantId}&date=${date}&time=${time}`);
        const data = await response.json();
        if (data.success) {
            return data.occupiedTables;  // Örnek: [1,3,5]
        } else {
            console.error("Dolu masalar alınamadı");
            return [];
        }
    } catch (error) {
        console.error("Dolu masalar fetch hatası:", error);
        return [];
    }
}


        dateInput.addEventListener('change', () => {
             generateTimeSlots();  // Tarih değişince saat aralıklarını da güncelle
             updateSummary();
             checkBookingAvailability();
        });


        // Initialize the application
        async function init() {
            await fetchRestaurantData();
            generateTimeSlots();
        }

        // Start the application
        init();
    </script>
</body>
</html>